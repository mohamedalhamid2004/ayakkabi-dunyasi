<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürün Detayı | Ayakkabı Dünyası</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <header>
        <a href="index.html" class="logo">
            <img src="images/logo.png" alt="AD" class="logo-icon">
            <span class="logo-text">Ayakkabı<span>Dünyası</span></span>
        </a>
        <nav><a href="index.html" style="text-decoration: none; color: #333;"><i class="fas fa-arrow-left"></i>
                Alışverişe Dön</a></nav>
    </header>

    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb" style="margin-bottom: 20px; color: #565959; font-size: 0.9rem;">
            <a href="index.html" style="color: #666;">Anasayfa</a> <span style="margin:0 5px;">›</span>
            <span id="breadcrumb-category">Kategori</span> <span style="margin:0 5px;">›</span>
            <span id="breadcrumb-name" style="color:#C7511F; font-weight:700;">Ürün</span>
        </div>

        <!-- Balanced Grid (Old Design Style: 1fr 1fr) -->
        <div class="detail-card" style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: start;">

            <!-- LEFT: Image & Description -->
            <div class="detail-left">
                <div class="detail-img-container"
                    style="position: sticky; top: 20px; border: 1px solid #eee; padding: 20px; border-radius: 8px; background: #fff;">
                    <img id="detail-img" src="" alt="Ürün Resmi"
                        style="width: 100%; max-height: 500px; object-fit: contain;">
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="font-size: 1.2rem; margin-bottom: 15px;">Ürün Açıklaması</h3>
                    <p id="detail-desc" style="line-height: 1.6; color: #333;"></p>
                </div>
            </div>

            <!-- RIGHT: Details & REVIEWS -->
            <div class="detail-content" style="display: flex; flex-direction: column; min-height: 600px;">
                <h1 id="detail-title" style="font-size: 1.8rem; line-height: 1.3; margin-bottom: 10px;"></h1>

                <div class="rating-container" style="margin-bottom: 15px;">
                    <span class="rating-stars" style="color: #FFA41C;"><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star-half-alt"></i></span>
                    <span class="rating-count" style="color: #007185; margin-left: 5px;">(125 Değerlendirme)</span>
                </div>

                <div class="price-section"
                    style="border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px;">
                    <div style="font-size: 0.9rem; color: #565959;">Fiyat:</div>
                    <div class="price-tag" id="detail-price" style="font-size: 1.8rem; color: #B12704;"></div>
                    <div style="font-size: 0.9rem; color: #007185;">KDV Dahil</div>
                </div>

                <!-- Colors (Preserved) -->
                <div id="color-section" style="margin-bottom: 20px;">
                    <div style="font-weight: 700; margin-bottom: 8px;">Renk: <span id="selected-color-name"
                            style="font-weight: 400;">Seçiniz</span></div>
                    <div id="color-options" style="display: flex; gap: 10px;"></div>
                </div>

                <!-- Size Selector (Preserved) -->
                <div class="size-selector-container" style="margin-bottom: 20px;">
                    <div class="size-label" style="font-weight: 700; margin-bottom: 10px;">Beden Seçiniz:</div>
                    <div class="size-options" id="size-options" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="size-btn">36</button>
                        <button class="size-btn">37</button>
                        <button class="size-btn">38</button>
                        <button class="size-btn">39</button>
                        <button class="size-btn">40</button>
                        <button class="size-btn">41</button>
                        <button class="size-btn">42</button>
                        <button class="size-btn">43</button>
                        <button class="size-btn">44</button>
                        <button class="size-btn">45</button>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div class="side-reviews"
                    style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; flex: 1; display: flex; flex-direction: column;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 10px;">Müşteri Yorumları</h3>

                    <div id="reviews-list"
                        style="flex: 1; min-height: 150px; max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <!-- Initial reviews or loaded via JS -->
                        <div class="review-item"
                            style="background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                                <strong>Ahmet Y.</strong>
                                <span style="color: #f27a1a;"><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                                        class="fas fa-star"></i><i class="fas fa-star"></i><i
                                        class="fas fa-star"></i></span>
                            </div>
                            <p style="font-size: 0.9rem; margin: 0;">Ürün harika, tam kalıp.</p>
                        </div>
                    </div>

                    <!-- Add Review Form -->
                    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                        <div style="font-weight:600; margin-bottom:5px;">Puanınız:</div>
                        <div class="star-rating-input" id="star-rating-input"
                            style="color:#ddd; font-size:1.2rem; cursor:pointer; margin-bottom:10px;">
                            <i class="far fa-star" data-rating="1"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="selected-rating" value="0">

                        <div style="display: flex; gap: 5px; margin-bottom: 20px;">
                            <input type="text" id="new-review-text" placeholder="Yorum yaz..."
                                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addReview()"
                                style="background: #333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight:600;">Gönder</button>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons (Moved to Bottom) -->
                <div class="action-buttons" style="display: flex; gap: 10px; margin-top: auto;">
                    <button class="add-to-cart-btn" id="add-cart-btn"
                        style="flex: 1; border-radius: 6px; padding: 15px; background: #f27a1a; color: white; border: none; font-weight: 700; cursor: pointer;">Sepete
                        Ekle</button>
                    <button id="buy-now-btn"
                        style="flex: 1; background: #fff; color: #f27a1a; border: 1px solid #f27a1a; padding: 15px; font-weight: 700; border-radius: 6px; cursor: pointer;">Hemen
                        Al</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay & Cart Sidebar -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="sidebar-header">
            <h3>Sepetim (<span class="cart-count">0</span>)</h3>
            <button onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-content" id="sidebar-cart-items"></div>
        <div class="sidebar-footer">
            <div class="total-bar">
                <span>Toplam:</span>
                <span id="sidebar-total">0 TL</span>
            </div>
            <button onclick="window.location.href='payment.html'" class="checkout-btn">Sepeti Onayla</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Footer -->
    <footer>
        <div class="footer-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
            <i class="fas fa-chevron-up"></i> Yukarıya Dön
        </div>
        <div class="footer-main">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>Müşteri Hizmetleri</h3>
                    <ul>
                        <li><a href="contact.html">Bize Ulaşın</a></li>
                        <li><a href="returns.html">İade ve Değişim</a></li>
                        <li><a href="order-status.html">Sipariş Takibi</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Kurumsal</h3>
                    <ul>
                        <li><a href="about.html">Hakkımızda</a></li>
                        <li><a href="careers.html">Kariyer</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Güvenli Ödeme</h3>
                    <div class="payment-icons">
                        <i class="fab fa-cc-visa"></i>
                        <i class="fab fa-cc-mastercard"></i>
                        <i class="fab fa-cc-amex"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2026 Ayakkabı Dünyası. Tüm Hakları Saklıdır.
        </div>
    </footer>

    <script src="js/script.js?v=fix5"></script>
    <script>
        // Size Selection
        const buttons = document.querySelectorAll('.size-btn');
        let selectedSize = null;

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedSize = btn.innerText;
                document.querySelector('.size-options').style.border = 'none';
            });
        });

        // Star Rating Logic
        const starContainer = document.getElementById('star-rating-input');
        const stars = starContainer.querySelectorAll('i');
        const ratingInput = document.getElementById('selected-rating');

        stars.forEach(star => {
            star.addEventListener('click', () => {
                const rating = star.getAttribute('data-rating');
                ratingInput.value = rating;
                updateStars(rating);
            });

            star.addEventListener('mouseover', () => {
                updateStars(star.getAttribute('data-rating'), true);
            });
        });

        starContainer.addEventListener('mouseleave', () => {
            updateStars(ratingInput.value);
        });

        function updateStars(rating, isHover = false) {
            stars.forEach(s => {
                const r = s.getAttribute('data-rating');
                if (r <= rating) {
                    s.classList.remove('far');
                    s.classList.add('fas');
                    s.style.color = '#ffa41c';
                } else {
                    s.classList.remove('fas');
                    s.classList.add('far');
                    s.style.color = '#ddd';
                }
            });
        }

        // "Sepete Ekle" Logic
        document.getElementById('add-cart-btn').addEventListener('click', () => {
            if (!selectedSize) {
                showToast("Ayakkabı numaranızı seçin", "error");
                const sizeOptions = document.querySelector('.size-options');
                sizeOptions.style.border = "2px solid red";
                sizeOptions.style.borderRadius = "4px";
                return;
            }

            const product = {
                id: getQueryParam('id') || '1',
                name: document.getElementById('detail-title').innerText,
                price: parseFloat(document.getElementById('detail-price').innerText.replace(' TL', '')),
                image: document.getElementById('detail-img').src,
                size: selectedSize,
                quantity: 1
            };

            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const existingItem = cart.find(item => item.id === product.id && item.size === product.size);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push(product);
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();
            renderSidebarCart();
            toggleSidebar(true);
            showToast('Sepete eklendi!', 'success');
        });

        // "Hemen Al" Logic
        document.getElementById('buy-now-btn').addEventListener('click', () => {
            if (!selectedSize) {
                showToast("Ayakkabı numaranızı seçin", "error");
                const sizeOptions = document.querySelector('.size-options');
                sizeOptions.style.border = "2px solid red";
                sizeOptions.style.borderRadius = "4px";
                return;
            }

            const product = {
                id: getQueryParam('id') || '1',
                name: document.getElementById('detail-title').innerText,
                price: parseFloat(document.getElementById('detail-price').innerText.replace(' TL', '')),
                image: document.getElementById('detail-img').src,
                size: selectedSize,
                quantity: 1
            };

            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const existingItem = cart.find(item => item.id === product.id && item.size === product.size);
            if (existingItem) { existingItem.quantity += 1; } else { cart.push(product); }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();
            window.location.href = 'payment.html';
        });


        async function addReview() {
            const productId = getQueryParam('id');
            const rating = document.getElementById('selected-rating').value;
            const reviewText = document.getElementById('new-review-text').value.trim();

            // Validation
            if (!rating || rating === '0') {
                showToast('Lütfen yıldız puanı seçiniz.', 'error');
                return;
            }
            if (!reviewText) {
                showToast('Lütfen yorum yazınız.', 'error');
                return;
            }

            try {
                // Get current product data
                const productRes = await fetch(`/api/products/${productId}`);
                if (!productRes.ok) throw new Error('Ürün bulunamadı');

                const product = await productRes.json();

                // Get username from localStorage
                const user = JSON.parse(localStorage.getItem('user'));
                const username = user ? user.username : 'Misafir';

                // Add new review
                const newReview = {
                    user: username,
                    rating: parseInt(rating),
                    comment: reviewText
                };

                const updatedReviews = [...(product.reviews || []), newReview];

                // Update product with new review
                const updateRes = await fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reviews: updatedReviews })
                });

                if (!updateRes.ok) throw new Error('Yorum eklenemedi');

                // Show success message
                showToast('Yorumunuz başarıyla eklendi!', 'success');

                // Reset form
                document.getElementById('selected-rating').value = '0';
                document.getElementById('new-review-text').value = '';
                const stars = document.querySelectorAll('#star-rating-input i');
                stars.forEach(s => {
                    s.classList.remove('fas');
                    s.classList.add('far');
                    s.style.color = '#ddd';
                });

                // Reload page to show new review
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('Review error:', error);
                showToast('Yorum eklenirken hata oluştu: ' + error.message, 'error');
            }
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
    </script>
</body>

</html>