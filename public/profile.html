<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hesabım | Ayakkabı Dünyası</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body>

    <!-- HEADER -->
    <header>
        <a href="index.html" class="logo">
            <img src="images/logo.png" alt="AD" class="logo-icon">
            <span class="logo-text">Ayakkabı<span>Dünyası</span></span>
        </a>

        <div class="search-wrapper">
            <select class="search-select">
                <option>Tüm Kategoriler</option>
                <option>Erkek</option>
                <option>Kadın</option>
                <option>Çocuk</option>
            </select>
            <input type="text" id="search-input" placeholder="Aradığınız ürünü yazınız...">
            <button id="search-btn"><i class="fas fa-search"></i></button>
        </div>

        <nav class="nav-links">
            <div class="nav-item" id="nav-account" onclick="window.location.href='profile.html'">
                <i class="fas fa-user" style="font-size: 1.2rem;"></i>
            </div>
            <div class="nav-item">
                <span>İadeler</span>
                <span>ve Siparişler</span>
            </div>
            <div class="cart-icon-wrapper" onclick="toggleSidebar()">
                <i class="fas fa-shopping-cart cart-icon"></i>
                <span class="cart-count">0</span>
            </div>
        </nav>
    </header>

    <!-- PROFILE CONTAINER -->
    <div class="container profile-container">

        <!-- SIDEBAR -->
        <aside class="profile-sidebar">
            <div class="user-summary">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <span class="welcome-text">Merhaba,</span>
                    <strong id="sidebar-username">Kullanıcı</strong>
                </div>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item" data-target="orders-section">
                    <i class="fas fa-box"></i> Siparişlerim
                </li>
                <li class="menu-item" data-target="address-section">
                    <i class="fas fa-map-marker-alt"></i> Adres Bilgilerim
                </li>
                <li class="menu-item active" data-target="user-info-section">
                    <i class="fas fa-user-cog"></i> Kullanıcı Bilgilerim
                </li>
                <li class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                </li>
            </ul>
        </aside>

        <!-- CONTENT AREA -->
        <main class="profile-content">

            <!-- ORDERS SECTION -->
            <section id="orders-section" class="content-section">
                <h2 class="section-header">Siparişlerim</h2>
                <div id="orders-list" class="orders-list">
                    <!-- Orders will be loaded here dynamically -->
                    <div class="loading-spinner">Yükleniyor...</div>
                </div>
            </section>

            <!-- ADDRESS SECTION -->
            <section id="address-section" class="content-section">
                <h2 class="section-header">Adres Bilgilerim</h2>
                <div class="content-card">
                    <form id="address-form">
                        <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <div class="form-group" style="flex:1;">
                                <label>Telefon</label>
                                <input type="text" id="address-phone" class="form-control" placeholder="05XX XXX XX XX"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>İl</label>
                                <input type="text" id="address-city" class="form-control" placeholder="İl"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <div class="form-group" style="flex:1;">
                                <label>İlçe</label>
                                <input type="text" id="address-district" class="form-control" placeholder="İlçe"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Açık Adres</label>
                            <textarea id="address-input" rows="4" placeholder="Cadde, Sokak, No, Daire..."
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary save-btn">Adresi Kaydet</button>
                    </form>
                </div>
            </section>

            <!-- USER INFO SECTION -->
            <section id="user-info-section" class="content-section active">
                <h2 class="section-header">Kullanıcı Bilgilerim</h2>
                <div class="content-card">
                    <form id="user-info-form">
                        <div class="form-group">
                            <label>Kullanıcı Adı (Ad Soyad)</label>
                            <input type="text" id="info-username">
                        </div>
                        <div class="form-group">
                            <label>E-posta Adresi</label>
                            <input type="email" id="info-email">
                        </div>
                        <div class="form-group">
                            <label>Yeni Şifre (İsteğe Bağlı)</label>
                            <input type="password" id="info-password" placeholder="Yeni şifre belirleyin">
                        </div>
                        <button type="submit" class="btn btn-primary save-btn">Bilgileri Güncelle</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <!-- Overlay & Cart Sidebar -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="cart-sidebar" id="cart-sidebar">
        <div class="sidebar-header">
            <h3>Sepetim (<span class="cart-count">0</span>)</h3>
            <button onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-content" id="sidebar-cart-items"></div>
        <div class="sidebar-footer">
            <div class="total-bar">
                <span>Toplam:</span>
                <span id="sidebar-total">0 TL</span>
            </div>
            <button onclick="window.location.href='payment.html'" class="checkout-btn">Sepeti Onayla</button>
        </div>
    </div>

    <!-- Toast Logic from script.js needs to be available or duplicated until script.js exposes it -->
    <div id="toast-container" class="toast-container"></div>

    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Profile page loaded, initializing...");

            // AUTH CHECK
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // --- 1. SET UP UI (Username, etc) ---
            document.getElementById('sidebar-username').textContent = user.username;
            const headerUsername = document.getElementById('header-username');
            if (headerUsername) headerUsername.textContent = user.username;

            // Sync Input Fields
            const infoUser = document.getElementById('info-username');
            if (infoUser) infoUser.value = user.username;
            const infoEmail = document.getElementById('info-email');
            if (infoEmail && user.email) infoEmail.value = user.email;


            // --- 2. SIDEBAR NAVIGATION LOGIC ---
            // We use event delegation or direct binding. Direct binding is fine here.
            const menuItems = document.querySelectorAll('.menu-item[data-target]');
            const sections = document.querySelectorAll('.content-section');

            function switchTab(targetId) {
                const targetSection = document.getElementById(targetId);
                const targetMenu = document.querySelector(`.menu-item[data-target="${targetId}"]`);

                if (targetSection && targetMenu) {
                    console.log("Switching to tab:", targetId);
                    // Reset all
                    sections.forEach(s => s.classList.remove('active'));
                    menuItems.forEach(m => m.classList.remove('active'));

                    // Activate target
                    targetSection.classList.add('active');
                    targetMenu.classList.add('active');
                } else {
                    console.warn("Target tab not found:", targetId);
                }
            }

            // Click Listeners
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const target = item.getAttribute('data-target');
                    switchTab(target);
                });
            });

            // Hash Navigation (e.g. profile.html#address-section)
            if (window.location.hash) {
                const hashId = window.location.hash.substring(1);
                switchTab(hashId);
            }


            // --- 3. FETCH DATA (Orders & Address) ---
            loadOrders(user.id);
            loadAddress(user.id);

            // Fetch fresh User Data to sync (Background)
            refreshUserData(user.id);
        });

        // --- HELPER FUNCTIONS ---

        async function refreshUserData(userId) {
            try {
                const res = await fetch(`/api/users/${userId}`);
                const freshUser = await res.json();
                if (freshUser.username) {
                    // Update LocalStorage
                    const stored = JSON.parse(localStorage.getItem('user')) || {};
                    stored.username = freshUser.username;
                    stored.address = freshUser.address; // Keep local sync
                    stored.phone = freshUser.phone;
                    stored.city = freshUser.city;
                    stored.district = freshUser.district;
                    if (freshUser.email) stored.email = freshUser.email;

                    localStorage.setItem('user', JSON.stringify(stored));

                    // Update UI text
                    document.getElementById('sidebar-username').textContent = freshUser.username;
                }
            } catch (e) { console.error("User sync failed", e); }
        }

        async function loadAddress(userId) {
            try {
                const res = await fetch(`/api/users/${userId}`);
                const u = await res.json();

                // Address Form Fields
                if (document.getElementById('address-input')) document.getElementById('address-input').value = u.address || '';
                if (document.getElementById('address-phone')) document.getElementById('address-phone').value = u.phone || '';
                if (document.getElementById('address-city')) document.getElementById('address-city').value = u.city || '';
                if (document.getElementById('address-district')) document.getElementById('address-district').value = u.district || '';

            } catch (e) { console.error("loadAddress error", e); }
        }

        async function loadOrders(userId) {
            const container = document.getElementById('orders-list');
            if (!container) return;
            container.innerHTML = '<div class="loading-spinner">Yükleniyor...</div>';

            try {
                const res = await fetch(`/api/orders?userId=${userId}`);
                const orders = await res.json();

                container.innerHTML = '';
                if (!orders || orders.length === 0) {
                    container.innerHTML = '<div class="empty-state">Henüz siparişiniz yok.</div>';
                    return;
                }

                orders.reverse().forEach(order => {
                    const date = new Date(order.created_at).toLocaleDateString('tr-TR');
                    let itemNames = 'Ürünler';
                    if (Array.isArray(order.items)) {
                        itemNames = order.items.map(i => `${i.name} (${i.price} TL)`).join(', ');
                    }

                    const html = `
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <span class="order-date"><i class="far fa-calendar-alt"></i> ${date}</span>
                                    <span class="order-summary">Toplam: <strong>${order.total} TL</strong></span>
                                </div>
                                <div class="order-status">${order.status || 'İşleniyor'}</div>
                            </div>
                            <div class="order-body">
                                <div class="order-products"><i class="fas fa-box"></i> ${itemNames}</div>
                                <div class="order-delivery"><i class="fas fa-map-marker-alt"></i> ${order.address || 'Adres belirtilmedi'}</div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            } catch (e) {
                console.error("loadOrders error", e);
                container.innerHTML = 'Siparişler yüklenirken hata oluştu.';
            }
        }

        // --- FORM HANDLERS ---
        // Address Save
        const addrForm = document.getElementById('address-form');
        if (addrForm) {
            addrForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = JSON.parse(localStorage.getItem('user'));
                const address = document.getElementById('address-input').value;
                const phone = document.getElementById('address-phone').value;
                const city = document.getElementById('address-city').value;
                const district = document.getElementById('address-district').value;

                try {
                    const res = await fetch('/api/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, address, phone, city, district })
                    });
                    if (res.ok) {
                        alert("Adres bilgileriniz güncellendi.");
                        refreshUserData(user.id);
                    } else alert("Güncelleme başarısız.");
                } catch (err) { console.error(err); alert("Hata oluştu."); }
            });
        }

        // User Info Save
        const infoForm = document.getElementById('user-info-form');
        if (infoForm) {
            infoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = JSON.parse(localStorage.getItem('user'));
                const username = document.getElementById('info-username').value;
                const email = document.getElementById('info-email').value;

                try {
                    const res = await fetch('/api/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, username, email })
                    });
                    if (res.ok) {
                        alert("Kullanıcı bilgileri güncellendi.");
                        refreshUserData(user.id);
                    } else alert("Güncelleme başarısız.");
                } catch (err) { console.error(err); }
            });
        }
    </script>
</body>

</html>